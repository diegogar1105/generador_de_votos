<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Electoral - Rep√∫blica de San Marcos (V2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container { max-width: 1200px; }
        .party-box {
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .party-input {
            width: 100%;
            padding: 8px;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }
        /* Colores de los partidos */
        .usm-color-bg { background-color: #fca5a5; } /* Red-300 */
        .unsm-color-bg { background-color: #93c5fd; } /* Blue-300 */
        .mnsm-color-bg { background-color: #a7f3d0; } /* Green-300 */
        .usm-color-border { border-color: #f87171; } /* Red-400 */
        .unsm-color-border { border-color: #60a5fa; } /* Blue-400 */
        .mnsm-color-border { border-color: #6ee7b7; } /* Green-400 */

        /* Estilo para los botones de acci√≥n */
        .btn-action {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">üó≥Ô∏è Simulador Electoral de San Marcos</h1>
            <h2 class="text-xl font-semibold text-gray-600 mt-1">¬°El Factor Sorpresa!</h2>
        </header>

        <!-- Controles Principales -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-700">Flujo de Simulaci√≥n</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Selector de A√±o -->
                <div>
                    <label for="electionYear" class="block text-sm font-medium text-gray-700 mb-1">Paso 1: A√±o Electoral:</label>
                    <input type="number" id="electionYear" value="2024" min="2024" class="party-input" placeholder="Ej: 2028">
                    <p id="censusProjection" class="text-xs text-gray-500 mt-1">Censo base: Cargando...</p>
                </div>

                <!-- Bot√≥n de Encuesta -->
                <div class="flex flex-col justify-end">
                    <button onclick="generateSurvey()" id="btnGenerateSurvey"
                        class="btn-action bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-4 focus:ring-yellow-500/50">
                        Paso 2: Pedir Encuesta Nacional
                    </button>
                </div>

                <!-- Bot√≥n de Ejecutar Elecci√≥n -->
                <div class="flex flex-col justify-end">
                    <button onclick="executeElection()" id="btnExecuteElection" disabled
                        class="btn-action bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 focus:ring-4 focus:ring-indigo-500/50">
                        Paso 3: Ejecutar Elecci√≥n
                    </button>
                </div>
            </div>
            <div id="error-message" class="mt-4 text-red-600 font-semibold hidden"></div>
        </div>
        
        <!-- Gesti√≥n de Historial -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-700">Gesti√≥n de Historial Electoral</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label for="historySelector" class="block text-sm font-medium text-gray-700 mb-1">Selecciona Elecci√≥n:</label>
                    <select id="historySelector" class="party-input bg-white" onchange="loadHistoricalElection()">
                        <option value="">Selecciona un a√±o guardado...</option>
                    </select>
                </div>
                <div class="flex flex-col justify-end gap-2">
                    <button onclick="openManageModal()" id="btnManageHistory" disabled
                        class="btn-action bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50">
                        Administrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Resultados de la Encuesta Nacional (El factor Expectativa) -->
        <div id="surveySection" class="p-6 rounded-xl shadow-md mb-8 hidden border-l-4 border-yellow-500 bg-yellow-100">
            <h3 class="text-2xl font-bold mb-4 text-yellow-800">Resultado de la Encuesta Nacional</h3>
            <p class="text-sm text-yellow-700 mb-4">La expectativa de los medios (margen de error $\pm 3\%$).</p>
            <div id="surveyResults" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Resultados de la encuesta generados por JS -->
            </div>
        </div>


        <!-- Resultados Detallados por Municipio (La Sorpresa) -->
        <div id="resultsSection" class="p-6 rounded-xl shadow-lg mb-8 hidden border-l-4 border-indigo-600 bg-indigo-50">
            <h3 class="text-2xl font-bold mb-4 text-indigo-800">Resultados Brutos Oficiales: <span id="resultsYear">2024</span></h3>
            <p class="text-sm text-indigo-600 mb-4 font-semibold">¬°El resultado real de la elecci√≥n, municipio por municipio! Suma estos n√∫meros para ver si la encuesta acert√≥.</p>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider sticky left-0 bg-indigo-100 z-10">Municipio (Estado)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Censo Electoral</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider usm-color-border usm-color-bg">Votos USM</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider unsm-color-border unsm-color-bg">Votos UNSM</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider mnsm-color-border mnsm-color-bg">Votos MNSM</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Total Votos</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">% Part.</th>
                        </tr>
                    </thead>
                    <tbody id="finalResultsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Resultados finales generados por JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal de Gesti√≥n de Historial -->
        <div id="manageModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
                <h4 class="text-xl font-bold mb-4 text-gray-800">Administrar Elecci√≥n <span id="managedYear"></span></h4>
                
                <p class="text-sm text-gray-600 mb-4">Nombre Actual: <span id="currentElectionName" class="font-semibold"></span></p>

                <div class="mb-4">
                    <label for="newElectionName" class="block text-sm font-medium text-gray-700 mb-1">Cambiar Nombre de la Elecci√≥n:</label>
                    <input type="text" id="newElectionName" class="party-input" placeholder="Ej: 'Elecci√≥n 2030: El Vuelco'">
                </div>
                
                <div class="flex justify-between space-x-4">
                    <button onclick="renameElection()" class="flex-1 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200">
                        Guardar Nombre
                    </button>
                    <button onclick="deleteElection()" class="flex-1 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">
                        Eliminar Elecci√≥n
                    </button>
                </div>
                <button onclick="closeManageModal()" class="w-full mt-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                    Cerrar
                </button>
            </div>
        </div>

        <!-- Modal de Notificaci√≥n -->
        <div id="notificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h4 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800"></h4>
                <p id="modalMessage" class="text-gray-600 mb-6"></p>
                <button onclick="closeModal()" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        // Configuraci√≥n inicial del pa√≠s
        const PARTIES = [
            { id: 'USM', name: 'Uni√≥n por San Marcos', colorClass: 'usm-color-bg' },
            { id: 'UNSM', name: 'Un Nuevo San Marcos', colorClass: 'unsm-color-bg' },
            { id: 'MNSM', name: 'Movimiento Nacional San Marcos', colorClass: 'mnsm-color-bg' },
        ];

        // Censo Electoral de 2024 (Poblaci√≥n Electoral Base)
        const BASE_CENSUS_2024 = [
            { state: 'Estado Capital', name: 'San Marcos', census: 1792243 },
            { state: 'Estado Capital', name: 'Puerto Alegre', census: 879344 },
            { state: 'Estado Uni√≥n', name: 'La Concordia', census: 1578390 },
            { state: 'Estado Uni√≥n', name: 'Villa Progreso', census: 1828172 },
            { state: 'Estado Uni√≥n', name: 'Nueva Esperanza', census: 1499511 },
            { state: 'Estado Domingo', name: 'Santo Domingo', census: 1838983 },
            { state: 'Estado Domingo', name: 'Las Colinas', census: 937953 },
            { state: 'Estado Domingo', name: 'Santa Mar√≠a', census: 1241191 },
            { state: 'Estado Domingo', name: 'El Pilar', census: 1886521 },
        ];

        const MIN_ANNUAL_GROWTH = 0.005; // 0.5%
        const MAX_ANNUAL_GROWTH = 0.015; // 1.5%
        const VOTE_NOISE_PERCENTAGE = 0.04; // +- 4% de ruido municipal (m√°s alto para m√°s sorpresa)
        const SURVEY_MOE = 0.03; // Margen de Error de la Encuesta +- 3%

        let currentCensusData = [];
        let currentYear = 2024;
        let selectedHistoricalYear = null;

        // --- Funciones de Utilidad y UI ---

        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('notificationModal').classList.remove('hidden');
            document.getElementById('notificationModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('notificationModal').classList.add('hidden');
            document.getElementById('notificationModal').classList.remove('flex');
        }
        
        function openManageModal() {
            const year = document.getElementById('historySelector').value;
            if (!year) return;
            selectedHistoricalYear = year;
            const history = getHistory();
            const electionName = history[year]?.name || `Elecci√≥n ${year}`;

            document.getElementById('managedYear').textContent = year;
            document.getElementById('currentElectionName').textContent = electionName;
            document.getElementById('newElectionName').value = electionName.startsWith('Elecci√≥n ') ? '' : electionName;
            document.getElementById('manageModal').classList.remove('hidden');
            document.getElementById('manageModal').classList.add('flex');
        }

        function closeManageModal() {
            document.getElementById('manageModal').classList.add('hidden');
            document.getElementById('manageModal').classList.remove('flex');
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomFloat(min, max) {
            return Math.random() * (max - min) + min;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-VE').format(Math.round(num));
        }

        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // --- Persistencia y Censo Electoral (Puntos 1 y 2) ---

        function getHistory() {
            const historyJson = localStorage.getItem('sanMarcosElections');
            return historyJson ? JSON.parse(historyJson) : {};
        }

        function saveElectionResults(year, name, census, results) {
            const history = getHistory();
            history[year] = { 
                name: name,
                census: census, 
                results: results, 
                timestamp: new Date().toISOString() 
            };
            localStorage.setItem('sanMarcosElections', JSON.stringify(history));
            updateHistorySelector();
            showModal("√âxito", `Los resultados de ${name} han sido guardados.`);
        }

        function getCensusForYear(targetYear) {
            const history = getHistory();
            const lastYear = Math.max(...Object.keys(history).map(Number).filter(y => y < targetYear), 2024);

            let censusData;

            if (targetYear === 2024) {
                censusData = BASE_CENSUS_2024;
            } else if (history[targetYear]) {
                censusData = history[targetYear].census;
            } else {
                const startCensus = lastYear === 2024 ? BASE_CENSUS_2024 : history[lastYear].census;
                const yearsToGrow = targetYear - lastYear;

                censusData = startCensus.map(m => {
                    let currentCensus = m.census;
                    for (let y = 0; y < yearsToGrow; y++) {
                        const growthRate = getRandomFloat(MIN_ANNUAL_GROWTH, MAX_ANNUAL_GROWTH);
                        currentCensus = currentCensus * (1 + growthRate);
                    }
                    return { ...m, census: Math.round(currentCensus) };
                });
            }
            return censusData;
        }

        function updateHistorySelector() {
            const selector = document.getElementById('historySelector');
            selector.innerHTML = '<option value="">Selecciona un a√±o guardado...</option>';
            const history = getHistory();
            const years = Object.keys(history).map(Number).sort((a, b) => b - a);

            years.forEach(year => {
                const electionName = history[year]?.name || `Elecci√≥n ${year}`;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = electionName;
                selector.appendChild(option);
            });

            // Habilitar o deshabilitar el bot√≥n de gesti√≥n
            document.getElementById('btnManageHistory').disabled = !selector.value;
        }

        // --- L√≥gica de Gesti√≥n (Borrar y Renombrar) ---

        function deleteElection() {
            const year = selectedHistoricalYear;
            if (!year) return;

            if (!confirm(`¬øEst√°s seguro de que quieres eliminar la elecci√≥n de ${year}? Esta acci√≥n es irreversible.`)) {
                return;
            }

            const history = getHistory();
            const nameToDelete = history[year]?.name || `Elecci√≥n ${year}`;
            delete history[year];
            localStorage.setItem('sanMarcosElections', JSON.stringify(history));
            
            closeManageModal();
            updateHistorySelector();
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('surveySection').classList.add('hidden');
            document.getElementById('historySelector').value = '';
            showModal("Eliminada", `La elecci√≥n "${nameToDelete}" ha sido eliminada del historial.`);
            initializeApp(); // Recalcular el censo proyectado por si el a√±o eliminado era el √∫ltimo.
        }

        function renameElection() {
            const year = selectedHistoricalYear;
            const newName = document.getElementById('newElectionName').value.trim();
            if (!year || !newName) {
                showModal("Error", "Debes ingresar un nuevo nombre para la elecci√≥n.");
                return;
            }

            const history = getHistory();
            if (history[year]) {
                history[year].name = newName;
                localStorage.setItem('sanMarcosElections', JSON.stringify(history));
                
                closeManageModal();
                updateHistorySelector();
                document.getElementById('historySelector').value = year; // Seleccionar el reci√©n renombrado
                document.getElementById('btnManageHistory').disabled = false;
                showModal("√âxito", `Nombre cambiado a: "${newName}"`);
            }
        }


        // --- L√≥gica de Generaci√≥n de Votos (El Factor Sorpresa) ---
        
        /** Genera una matriz de ponderaciones completamente aleatoria por municipio. */
        function generateRandomWeights(municipios) {
            const weights = {};
            municipios.forEach(m => {
                weights[m.name] = {};
                // Asignaci√≥n aleatoria entre 0 y 10 para cada partido
                PARTIES.forEach(p => {
                    weights[m.name][p.id] = getRandomInt(0, 10);
                });
                
                // Asegurar que al menos un partido tenga presencia (suma > 0)
                let totalWeight = PARTIES.reduce((sum, p) => sum + weights[m.name][p.id], 0);
                if (totalWeight === 0) {
                    weights[m.name][PARTIES[0].id] = 1; 
                }
            });
            return weights;
        }
        
        /** Genera los votos brutos por municipio y partido usando las ponderaciones internas. */
        function calculateVotes(censusData, weights) {
            const results = [];
            let totalVotesNational = 0;
            let totalPartyVotesNational = { USM: 0, UNSM: 0, MNSM: 0 };

            censusData.forEach(m => {
                const totalWeight = PARTIES.reduce((sum, p) => sum + weights[m.name][p.id], 0);
                const municipalResults = {
                    municipality: m.name,
                    state: m.state,
                    census: m.census,
                    votes: {},
                    totalVotes: 0,
                    participation: 0,
                };

                let totalVotesInMunicipality = 0;

                PARTIES.forEach(p => {
                    const partyId = p.id;
                                       const weight = weights[m.name][partyId];

                    // 1. Votos Ideales (Proporcional a la Ponderaci√≥n)
                    const idealVoteShare = weight / totalWeight;
                    const idealVotes = m.census * idealVoteShare;

                    // 2. Ruido Aleatorio (Simulando Error/Dispersi√≥n)
                    const noiseFactor = getRandomFloat(-VOTE_NOISE_PERCENTAGE, VOTE_NOISE_PERCENTAGE);
                    const noise = idealVotes * noiseFactor;

                    // 3. Votos Finales
                    let finalVotes = Math.max(0, Math.round(idealVotes + noise));

                    if (finalVotes > m.census) {
                        finalVotes = m.census;
                    }

                    municipalResults.votes[partyId] = finalVotes;
                    totalVotesInMunicipality += finalVotes;
                    totalPartyVotesNational[partyId] += finalVotes;
                });

                municipalResults.totalVotes = totalVotesInMunicipality;
                municipalResults.participation = (totalVotesInMunicipality / m.census) * 100;
                results.push(municipalResults);
                totalVotesNational += totalVotesInMunicipality;
            });

            return { municipalResults: results, nationalTotals: totalPartyVotesNational, nationalTotalVotes: totalVotesNational };
        }

        /** Genera y muestra la encuesta nacional simulada (Paso 2). */
        function generateSurvey() {
            const yearInput = document.getElementById('electionYear');
            currentYear = parseInt(yearInput.value);

            if (isNaN(currentYear) || currentYear < 2024) {
                displayError("El a√±o electoral debe ser un n√∫mero igual o posterior a 2024.");
                return;
            }

            // Obtener Censo Proyectado y actualizar UI
            currentCensusData = getCensusForYear(currentYear);
            document.getElementById('censusProjection').textContent = `Censo base para ${currentYear}: ${formatNumber(currentCensusData.reduce((acc, m) => acc + m.census, 0))}`;
            
            // 1. Generar Ponderaciones de la Encuesta (Simula una distribuci√≥n normal)
            const surveyWeights = generateRandomWeights(currentCensusData);
            
            // 2. Calcular Votos Nacionales IDEALES (sin ruido municipal, para la base de la encuesta)
            const { nationalTotals, nationalTotalVotes } = calculateVotes(currentCensusData, surveyWeights);

            const surveyDiv = document.getElementById('surveyResults');
            surveyDiv.innerHTML = '';
            document.getElementById('surveySection').classList.remove('hidden');
            
            let surveyNationalPercentages = {};

            PARTIES.forEach(p => {
                const realPercentage = (nationalTotals[p.id] / nationalTotalVotes) * 100;
              
                // Aplicar error aleatorio DENTRO del MOE
                const randomError = getRandomFloat(-SURVEY_MOE, SURVEY_MOE) * 100;
                const surveyPercentage = Math.max(0, Math.min(100, realPercentage + randomError));

                surveyNationalPercentages[p.id] = surveyPercentage;

                const card = document.createElement('div');
                card.className = 'party-box text-center ' + p.colorClass;
                card.innerHTML = `
                    <p class="text-sm font-semibold text-gray-800">${p.name} (${p.id})</p>
                    <p class="text-3xl font-extrabold mt-1 text-gray-900">${surveyPercentage.toFixed(2)}%</p>
                    <p class="text-xs text-gray-700">Expectativa</p>
                `;
                surveyDiv.appendChild(card);
            });
            
            // 3. Guardar el resultado esperado (para referencia, no es el resultado final)
            // No guardamos la encuesta en el historial, solo la mostramos.
            
            // 4. Habilitar Ejecuci√≥n de Elecci√≥n
            document.getElementById('btnExecuteElection').disabled = false;
            document.getElementById('resultsSection').classList.add('hidden'); // Ocultar resultados viejos
            showModal("Encuesta Lista", `Se ha generado la expectativa nacional para ${currentYear}. ¬°Ahora ejecuta la elecci√≥n para ver la sorpresa!`);
        }
        
        /** Ejecuta la elecci√≥n real con factores aleatorios (Paso 3). */
        function executeElection() {
            document.getElementById('btnExecuteElection').disabled = true;

            // 1. Generar una estructura de poder NUEVA y ALEATORIA para el resultado real
            const finalWeights = generateRandomWeights(currentCensusData);

            // 2. Calcular Votos reales con la estructura de poder aleatoria
            const { municipalResults, nationalTotals, nationalTotalVotes } = calculateVotes(currentCensusData, finalWeights);
            
            // 3. Nombrar la elecci√≥n y Guardar en Historial
            const electionName = `Elecci√≥n ${currentYear}`;
            saveElectionResults(currentYear, electionName, currentCensusData, municipalResults);
            
            // 4. Renderizar Resultados Finales
            renderFinalResults(municipalResults, currentYear);
            document.getElementById('historySelector').value = currentYear; // Seleccionar la nueva elecci√≥n

            showModal("¬°ELECCI√ìN EJECUTADA!", `Los votos reales para el a√±o ${currentYear} han sido calculados y guardados. ¬°Comprueba si la encuesta acert√≥!`);
        }


        // --- Renderizado de Resultados Finales ---

        function renderFinalResults(results, year) {
            const tbody = document.getElementById('finalResultsTableBody');
            tbody.innerHTML = '';
            document.getElementById('resultsYear').textContent = year;
            document.getElementById('resultsSection').classList.remove('hidden');

            let grandTotalVotes = 0;
            let grandTotalCensus = 0;
            let grandTotalPartyVotes = { USM: 0, UNSM: 0, MNSM: 0 };

            results.forEach((m) => {
                grandTotalVotes += m.totalVotes;
                grandTotalCensus += m.census;
                PARTIES.forEach(p => { grandTotalPartyVotes[p.id] += m.votes[p.id]; });

                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-100 transition duration-150';

                // Columna 1: Municipio
                let cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 bg-white';
                cell.innerHTML = `${m.municipality} <span class="text-xs font-normal text-gray-500">(${m.state})</span>`;

                // Columna 2: Censo
                cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-500 text-center';
                cell.textContent = formatNumber(m.census);

                // Columnas 3, 4, 5: Votos por Partido
                PARTIES.forEach(p => {
                    cell = row.insertCell();
                    cell.className = 'px-3 py-3 whitespace-nowrap text-sm font-bold text-gray-800 text-center';
                    cell.textContent = formatNumber(m.votes[p.id]);
                });

                // Columna 6: Total Votos
                cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm font-bold text-indigo-700 text-center';
                cell.textContent = formatNumber(m.totalVotes);

                // Columna 7: % Participaci√≥n
                cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-700 text-center';
                cell.textContent = `${m.participation.toFixed(2)}%`;
            });
            
            // Fila de Totales Nacionales (Solo para referencia, el usuario debe sumarlos)
            const totalRow = tbody.insertRow();
            totalRow.className = 'bg-gray-200 font-extrabold';
            
            totalRow.insertCell().textContent = 'TOTAL NACIONAL';
            totalRow.insertCell().textContent = formatNumber(grandTotalCensus);
            PARTIES.forEach(p => {
                totalRow.insertCell().textContent = formatNumber(grandTotalPartyVotes[p.id]);
            });
            totalRow.insertCell().textContent = formatNumber(grandTotalVotes);
            totalRow.insertCell().textContent = grandTotalCensus > 0 ? `${(grandTotalVotes / grandTotalCensus * 100).toFixed(2)}%` : '0%';
        }
  
        // --- Funciones de Control y Carga ---

        function updateUIOnYearChange() {
            const yearInput = document.getElementById('electionYear');
            currentYear = parseInt(yearInput.value);
            
            document.getElementById('btnExecuteElection').disabled = true;
            document.getElementById('surveySection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            if (currentYear >= 2024) {
                currentCensusData = getCensusForYear(currentYear);
                const totalCensus = currentCensusData.reduce((acc, m) => acc + m.census, 0);
                document.getElementById('censusProjection').textContent = `Censo base para ${currentYear}: ${formatNumber(totalCensus)}`;
            } else {
                document.getElementById('censusProjection').textContent = `A√±o inv√°lido (debe ser 2024 o posterior).`;
            }

            document.getElementById('historySelector').value = '';
            document.getElementById('btnManageHistory').disabled = true;
        }

        function loadHistoricalElection() {
            const year = document.getElementById('historySelector').value;
            if (!year) {
                updateUIOnYearChange(); // Limpiar y resetear al a√±o actual
                return;
            }

            const history = getHistory();
            const electionData = history[year];

            if (electionData) {
                document.getElementById('electionYear').value = year;
                currentCensusData = electionData.census;
                currentYear = parseInt(year);

                const totalCensus = currentCensusData.reduce((acc, m) => acc + m.census, 0);
                document.getElementById('censusProjection').textContent = `Censo usado para ${year}: ${formatNumber(totalCensus)}`;

                // Recalcular Totales para generar la encuesta basada en los resultados reales G U A R D A D O S
                let nationalTotals = { USM: 0, UNSM: 0, MNSM: 0 };
                let nationalTotalVotes = 0;
                electionData.results.forEach(m => {
                    PARTIES.forEach(p => { nationalTotals[p.id] += m.votes[p.id]; });
                    nationalTotalVotes += m.totalVotes;
                });
                
                // Mostrar resultados y una encuesta "basada" en ellos (para mantener la estructura de la interfaz)
                generateAndRenderSurvey(nationalTotals, nationalTotalVotes); 
                renderFinalResults(electionData.results, year);
                
                document.getElementById('btnExecuteElection').disabled = true;
                document.getElementById('btnManageHistory').disabled = false;
                
                showModal("Hist√≥rico Cargado", `Se ha cargado: "${electionData.name || `Elecci√≥n ${year}`}"`);
            } else {
                displayError("No se encontraron datos para el a√±o seleccionado.");
            }
        }
  
        function initializeApp() {
            document.getElementById('electionYear').addEventListener('change', updateUIOnYearChange);
            document.getElementById('electionYear').addEventListener('keyup', updateUIOnYearChange);
            updateHistorySelector();
            updateUIOnYearChange(); // Carga la informaci√≥n inicial de 2024
        }
        
        // Funci√≥n auxiliar para renderizar la encuesta al cargar historial
        function generateAndRenderSurvey(nationalTotals, nationalTotalVotes) {
             const surveyDiv = document.getElementById('surveyResults');
            surveyDiv.innerHTML = '';
            document.getElementById('surveySection').classList.remove('hidden');

            const total = nationalTotalVotes;

            PARTIES.forEach(p => {
                const realPercentage = (nationalTotals[p.id] / total) * 100;

                // Aplicar error aleatorio DENTRO del MOE para simular una encuesta
                const randomError = getRandomFloat(-SURVEY_MOE, SURVEY_MOE) * 100;
                const surveyPercentage = Math.max(0, Math.min(100, realPercentage + randomError)); 

                const card = document.createElement('div');
                card.className = 'party-box text-center ' + p.colorClass;

                card.innerHTML = `
                    <p class="text-sm font-semibold text-gray-800">${p.name} (${p.id})</p>
                    <p class="text-3xl font-extrabold mt-1 text-gray-900">${surveyPercentage.toFixed(2)}%</p>
                    <p class="text-xs text-gray-700">Expectativa</p>
                `;
                surveyDiv.appendChild(card);
            });
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
