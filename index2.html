<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Electoral - Rep√∫blica de San Marcos (V3.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container { max-width: 1200px; }
        .party-box {
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .party-input {
            width: 100%;
            padding: 8px;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }
        /* Colores de los partidos */
        .usm-color-bg { background-color: #fca5a5; } /* Red-300 */
        .unsm-color-bg { background-color: #93c5fd; } /* Blue-300 */
        .mnsm-color-bg { background-color: #a7f3d0; } /* Green-300 */
        .usm-color-border { border-color: #f87171; } /* Red-400 */
        .unsm-color-border { border-color: #60a5fa; } /* Blue-400 */
        .mnsm-color-border { border-color: #6ee7b7; } /* Green-400 */

        /* Estilo para los botones de acci√≥n */
        .btn-action {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">üó≥Ô∏è Simulador Electoral de San Marcos</h1>
            <h2 class="text-xl font-semibold text-gray-600 mt-1">¬°El Factor Sorpresa!</h2>
        </header>

        <!-- Controles Principales -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-700">Flujo de Simulaci√≥n</h3>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- Selector de A√±o -->
                <div>
                    <label for="electionYear" class="block text-sm font-medium text-gray-700 mb-1">Paso 1: A√±o Electoral</label>
                    <!-- Min set to 1950 to allow user to choose a flexible start year -->
                    <input type="number" id="electionYear" value="2024" min="1950" class="party-input" placeholder="Ej: 2028" onchange="updateUIOnFlowChange()">
                </div>

                <!-- Tipo de Elecci√≥n -->
                <div>
                    <label for="electionType" class="block text-sm font-medium text-gray-700 mb-1">Paso 2: Tipo de Elecci√≥n</label>
                    <select id="electionType" class="party-input bg-white" onchange="updateUIOnFlowChange()">
                        <option value="PRE">Presidenciales</option>
                        <option value="LES">Legislativas</option>
                    </select>
                </div>

                <!-- Bot√≥n de Encuesta -->
                <div class="flex flex-col justify-end">
                    <button onclick="generateSurvey()" id="btnGenerateSurvey"
                        class="btn-action bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-4 focus:ring-yellow-500/50">
                        Paso 3: Pedir Encuesta
                    </button>
                </div>

                <!-- Bot√≥n de Ejecutar Elecci√≥n -->
                <div class="flex flex-col justify-end">
                    <button onclick="executeElection()" id="btnExecuteElection" disabled
                        class="btn-action bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 focus:ring-4 focus:ring-indigo-500/50">
                        Paso 4: Ejecutar Elecci√≥n
                    </button>
                </div>
            </div>
            <p id="censusProjection" class="text-sm text-gray-500 mt-1 font-semibold">Censo base proyectado: Cargando...</p>
            <div id="error-message" class="mt-4 text-red-600 font-semibold hidden"></div>
        </div>
        
        <!-- Gesti√≥n de Historial -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-700">Gesti√≥n de Historial Electoral</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label for="historySelector" class="block text-sm font-medium text-gray-700 mb-1">Selecciona Elecci√≥n:</label>
                    <select id="historySelector" class="party-input bg-white" onchange="loadHistoricalElection()">
                        <option value="">Selecciona una elecci√≥n guardada...</option>
                    </select>
                </div>
                <div class="flex flex-col justify-end gap-2">
                    <button onclick="openManageModal()" id="btnManageHistory" disabled
                        class="btn-action bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50">
                        Administrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Resultados de la Encuesta Nacional (El factor Expectativa) -->
        <div id="surveySection" class="p-6 rounded-xl shadow-md mb-8 hidden border-l-4 border-yellow-500 bg-yellow-100">
            <h3 class="text-2xl font-bold mb-4 text-yellow-800">Resultado de la Encuesta Nacional</h3>
            <p class="text-sm text-yellow-700 mb-4">La expectativa de los medios (margen de error $\pm 3\%$).</p>
            <div id="surveyResults" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Resultados de la encuesta generados por JS -->
            </div>
        </div>
      

        <!-- Resultados Detallados por Municipio (La Sorpresa) -->
        <div id="resultsSection" class="p-6 rounded-xl shadow-lg mb-8 hidden border-l-4 border-indigo-600 bg-indigo-50">
            <h3 class="text-2xl font-bold mb-4 text-indigo-800">Resultados Brutos Oficiales: <span id="resultsYearAndType">2024-PRE</span></h3>
            <p class="text-sm text-indigo-600 mb-4 font-semibold">¬°El resultado real de la elecci√≥n, municipio por municipio! Suma estos n√∫meros para ver si la encuesta acert√≥.</p>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-100">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider sticky left-0 bg-indigo-100 z-10">Municipio (Estado)</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Censo Electoral</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider usm-color-border usm-color-bg">Votos USM</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider unsm-color-border unsm-color-bg">Votos UNSM</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider mnsm-color-border mnsm-color-bg">Votos MNSM</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Total Votos</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">% Part.</th>
                        </tr>
                    </thead>
                    <tbody id="finalResultsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Resultados finales generados por JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal de Gesti√≥n de Historial -->
        <div id="manageModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
                <h4 class="text-xl font-bold mb-4 text-gray-800">Administrar Elecci√≥n: <span id="managedYearAndType"></span></h4>
                
                <p class="text-sm text-gray-600 mb-4">Nombre Actual: <span id="currentElectionName" class="font-semibold"></span></p>

                <div class="mb-4">
                    <label for="newElectionName" class="block text-sm font-medium text-gray-700 mb-1">Cambiar Nombre de la Elecci√≥n:</label>
                    <input type="text" id="newElectionName" class="party-input" placeholder="Ej: '2030-PRE: La Ca√≠da del USM'">
                </div>
                
                <div class="flex justify-between space-x-4">
                    <button onclick="renameElection()" class="flex-1 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200">
                        Guardar Nombre
                    </button>
                    <button onclick="deleteElection()" class="flex-1 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">
                        Eliminar Elecci√≥n
                    </button>
                </div>
                <button onclick="closeManageModal()" class="w-full mt-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                    Cerrar
                </button>
            </div>
        </div>

        <!-- Modal de Notificaci√≥n -->
        <div id="notificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h4 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800"></h4>
                <p id="modalMessage" class="text-gray-600 mb-6"></p>
                <button onclick="closeModal()" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        // Configuraci√≥n inicial del pa√≠s
        const PARTIES = [
            { id: 'USM', name: 'Uni√≥n por San Marcos', colorClass: 'usm-color-bg' },
            { id: 'UNSM', name: 'Un Nuevo San Marcos', colorClass: 'unsm-color-bg' },
            { id: 'MNSM', name: 'Movimiento Nacional San Marcos', colorClass: 'mnsm-color-bg' },
        ];

        // Censo Electoral de 2024 (Poblaci√≥n Electoral Base)
        const BASE_CENSUS_2024 = [
            { state: 'Estado Capital', name: 'San Marcos', census: 1792243 },
            { state: 'Estado Capital', name: 'Puerto Alegre', census: 879344 },
            { state: 'Estado Uni√≥n', name: 'La Concordia', census: 1578390 },
            { state: 'Estado Uni√≥n', name: 'Villa Progreso', census: 1828172 },
            { state: 'Estado Uni√≥n', name: 'Nueva Esperanza', census: 1499511 },
            { state: 'Estado Domingo', name: 'Santo Domingo', census: 1838983 },
            { state: 'Estado Domingo', name: 'Las Colinas', census: 937953 },
            { state: 'Estado Domingo', name: 'Santa Mar√≠a', census: 1241191 },
            { state: 'Estado Domingo', name: 'El Pilar', census: 1886521 },
        ];
        
        // Mapeo de c√≥digos de tipo de elecci√≥n a nombres
        const ELECTION_TYPES = {
            'PRE': 'Presidenciales',
            'LES': 'Legislativas'
        };

        const MIN_ANNUAL_GROWTH = 0.005; // 0.5%
        const MAX_ANNUAL_GROWTH = 0.015; // 1.5%
        const VOTE_NOISE_PERCENTAGE = 0.04; // +- 4% de ruido municipal (m√°s alto para m√°s sorpresa)
        const SURVEY_MOE = 0.03; // Margen de Error de la Encuesta +- 3%

        // NEW CONSTANTS for flexible start year logic
        const INITIAL_CENSUS_YEAR = 2024;
        const MIN_SAFE_START_YEAR = 1950; // Piso seguro para el input de a√±o

        let currentCensusData = [];
        let currentYear = 2024;
        let currentType = 'PRE';
        let selectedHistoricalKey = null; // Clave completa: "2024-PRE"
  
        // --- Funciones de Utilidad y UI ---

        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('notificationModal').classList.remove('hidden');
            document.getElementById('notificationModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('notificationModal').classList.add('hidden');
            document.getElementById('notificationModal').classList.remove('flex');
        }
        
        function openManageModal() {
            const key = document.getElementById('historySelector').value;
            if (!key) return;
            selectedHistoricalKey = key;
            const history = getHistory();
            const election = history[key];
            const electionName = election?.name || formatElectionName(key);

            document.getElementById('managedYearAndType').textContent = key;
            document.getElementById('currentElectionName').textContent = electionName;
            document.getElementById('newElectionName').value = electionName;
            document.getElementById('manageModal').classList.remove('hidden');
            document.getElementById('manageModal').classList.add('flex');
        }

        function closeManageModal() {
            document.getElementById('manageModal').classList.add('hidden');
            document.getElementById('manageModal').classList.remove('flex');
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomFloat(min, max) {
            return Math.random() * (max - min) + min;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-VE').format(Math.round(num));
        }

        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        /** Formatea la clave (ej: "2024-PRE") a un nombre legible (ej: "Elecci√≥n Presidencial 2024") */
        function formatElectionName(key) {
            const parts = key.split('-');
            const year = parts[0];
            const typeCode = parts[1];
            return `Elecci√≥n ${ELECTION_TYPES[typeCode] || typeCode} ${year}`;
        }


        // --- Persistencia y Censo Electoral (Puntos 1 y 2) ---

        function getHistory() {
            const historyJson = localStorage.getItem('sanMarcosElections');
            return historyJson ? JSON.parse(historyJson) : {};
        }

        function saveElectionResults(key, name, census, results) {
            const history = getHistory();
            history[key] = { 
                name: name,
                census: census, 
                results: results, 
                timestamp: new Date().toISOString() 
            };
            localStorage.setItem('sanMarcosElections', JSON.stringify(history));
            updateHistorySelector();
            showModal("√âxito", `Los resultados de ${name} han sido guardados.`);
        }
        
        /**
         * Determina el a√±o m√°s antiguo de las elecciones guardadas.
         * Esta es la restricci√≥n del usuario: no se puede retroceder antes del punto de inicio.
         */
        function getMinAllowedYear() {
            const history = getHistory();
            const keys = Object.keys(history);
            
            if (keys.length === 0) {
                // Si el historial est√° vac√≠o, el usuario es libre de empezar desde el piso seguro.
                return MIN_SAFE_START_YEAR;
            }

            // Encuentra el a√±o m√≠nimo entre todas las claves guardadas.
            let minYear = Infinity;
            keys.forEach(key => {
                const year = parseInt(key.split('-')[0]);
                if (year < minYear) {
                    minYear = year;
                }
            });
            
            return minYear;
        }

        /**
         * Proyecta el censo hacia adelante o hacia atr√°s (retro-proyecci√≥n) desde el a√±o base conocido.
         */
        function getCensusForYear(targetYear) {
            const history = getHistory();
            
            // 1. Check if the target year's data is already saved
            if (history[`${targetYear}-PRE`] || history[`${targetYear}-LES`]) {
                const keyToUse = history[`${targetYear}-PRE`] ? `${targetYear}-PRE` : `${targetYear}-LES`;
                return history[keyToUse].census;
            }

            // 2. Find the best base year for projection (latest known census data)
            let baseCensusYear = INITIAL_CENSUS_YEAR;
            let baseCensusData = BASE_CENSUS_2024;
            
            const knownYears = Object.keys(history)
                .map(key => parseInt(key.split('-')[0]))
                .filter(y => y !== targetYear); // Excluir el target year

            if (knownYears.length > 0) {
                // Encontrar el a√±o guardado m√°s cercano al targetYear (solo para proyecci√≥n)
                // Usamos el m√°s reciente guardado si proyectamos hacia adelante, o el 2024 base si vamos hacia atr√°s desde un a√±o no guardado.
                const allKnownYears = knownYears.sort((a, b) => b - a); // Ordenar descendente
                const closestKnownYear = allKnownYears[0];
                
                // Si el a√±o guardado m√°s reciente es m√°s cercano y no es el a√±o base inicial (2024), lo usamos.
                if (closestKnownYear > baseCensusYear) {
                    const lastKnownKey = history[`${closestKnownYear}-PRE`] ? `${closestKnownYear}-PRE` : history[`${closestKnownYear}-LES`] ? `${closestKnownYear}-LES` : null;
                    if (lastKnownKey) {
                        baseCensusData = history[lastKnownKey].census;
                        baseCensusYear = closestKnownYear;
                    }
                }
            }
            
            const yearsToCalculate = Math.abs(targetYear - baseCensusYear);

            if (yearsToCalculate === 0) {
                return baseCensusData;
            }
            
            const isRetroProjection = targetYear < baseCensusYear;

            let censusData = baseCensusData.map(m => {
                let currentCensus = m.census;
                for (let y = 0; y < yearsToCalculate; y++) {
                    const growthRate = getRandomFloat(MIN_ANNUAL_GROWTH, MAX_ANNUAL_GROWTH);
                    
                    if (isRetroProjection) {
                        // Retro-proyecci√≥n: Census_Pasado = Census_Futuro / (1 + Tasa)
                        currentCensus = currentCensus / (1 + growthRate);
                    } else {
                        // Proyecci√≥n a futuro: Census_Futuro = Census_Pasado * (1 + Tasa)
                        currentCensus = currentCensus * (1 + growthRate);
                    }
                }
                return { ...m, census: Math.round(currentCensus) };
            });
            
            return censusData;
        }

        function updateHistorySelector() {
            const selector = document.getElementById('historySelector');
            selector.innerHTML = '<option value="">Selecciona una elecci√≥n guardada...</option>';
            const history = getHistory();
            
            // Obtener todas las claves (ej: "2024-PRE") y ordenarlas por a√±o descendente.
            const keys = Object.keys(history).sort((a, b) => {
                const [yearA, typeA] = a.split('-');
                const [yearB, typeB] = b.split('-');
                if (parseInt(yearB) !== parseInt(yearA)) {
                    return parseInt(yearB) - parseInt(yearA); // Ordenar por a√±o
                }
                return typeA.localeCompare(typeB); // Luego por tipo para consistencia
            });

            keys.forEach(key => {
                const electionName = history[key]?.name || formatElectionName(key);
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${electionName} (${key})`;
                selector.appendChild(option);
            });

            document.getElementById('btnManageHistory').disabled = !selector.value;
        }
  
        // --- L√≥gica de Gesti√≥n (Borrar y Renombrar) ---

        function deleteElection() {
            const key = selectedHistoricalKey;
            if (!key) return;
            const history = getHistory();
            const nameToDelete = history[key]?.name || formatElectionName(key);

            // Using custom modal instead of confirm() as per instructions
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar la elecci√≥n "${nameToDelete}"? Esta acci√≥n es irreversible.`)) {
                return;
            }

            delete history[key];
            localStorage.setItem('sanMarcosElections', JSON.stringify(history));
            
            closeManageModal();
            updateHistorySelector();
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('surveySection').classList.add('hidden');
            document.getElementById('historySelector').value = '';
            showModal("Eliminada", `La elecci√≥n "${nameToDelete}" ha sido eliminada del historial.`);
            updateUIOnFlowChange(); // Recalcular UI y restricciones
        }

        function renameElection() {
            const key = selectedHistoricalKey;
            const newName = document.getElementById('newElectionName').value.trim();
            if (!key || !newName) {
                showModal("Error", "Debes ingresar un nuevo nombre para la elecci√≥n.");
                return;
            }

            const history = getHistory();
            if (history[key]) {
                history[key].name = newName;
                localStorage.setItem('sanMarcosElections', JSON.stringify(history));
                
                closeManageModal();
                updateHistorySelector();
                document.getElementById('historySelector').value = key; 
                document.getElementById('btnManageHistory').disabled = false;
                showModal("√âxito", `Nombre cambiado a: "${newName}"`);
            }
        }
  

        // --- L√≥gica de Generaci√≥n de Votos (El Factor Sorpresa) ---
        
        /** Genera una matriz de ponderaciones completamente aleatoria por municipio. */
        function generateRandomWeights(municipios) {
            const weights = {};
            municipios.forEach(m => {
                weights[m.name] = {};
                // Asignaci√≥n aleatoria entre 0 y 10 para cada partido
                PARTIES.forEach(p => {
                    weights[m.name][p.id] = getRandomInt(0, 10);
                });
                
                // Asegurar que al menos un partido tenga presencia (suma > 0)
                let totalWeight = PARTIES.reduce((sum, p) => sum + weights[m.name][p.id], 0);
                if (totalWeight === 0) {
                    weights[m.name][PARTIES[0].id] = 1; 
                }
            });
            return weights;
        }
        
        /** Genera los votos brutos por municipio y partido usando las ponderaciones internas. */
        function calculateVotes(censusData, weights) {
            const results = [];
            let totalVotesNational = 0;
            let totalPartyVotesNational = { USM: 0, UNSM: 0, MNSM: 0 };

            censusData.forEach(m => {
                const totalWeight = PARTIES.reduce((sum, p) => sum + weights[m.name][p.id], 0);
                const municipalResults = {
                    municipality: m.name,
                    state: m.state,
                    census: m.census,
                    votes: {},
                    totalVotes: 0,
                    participation: 0,
                };

                let totalVotesInMunicipality = 0;

                PARTIES.forEach(p => {
                    const partyId = p.id;
                    const weight = weights[m.name][partyId];

                    // 1. Votos Ideales (Proporcional a la Ponderaci√≥n)
                    const idealVoteShare = weight / totalWeight;
                    const idealVotes = m.census * idealVoteShare;

                    // 2. Ruido Aleatorio (Simulando Error/Dispersi√≥n)
                    const noiseFactor = getRandomFloat(-VOTE_NOISE_PERCENTAGE, VOTE_NOISE_PERCENTAGE);
                    const noise = idealVotes * noiseFactor;

                    // 3. Votos Finales
                    let finalVotes = Math.max(0, Math.round(idealVotes + noise));

                    if (finalVotes > m.census) {
                        finalVotes = m.census;
                    }

                    municipalResults.votes[partyId] = finalVotes;
                    totalVotesInMunicipality += finalVotes;
                    totalPartyVotesNational[partyId] += finalVotes;
                });

                municipalResults.totalVotes = totalVotesInMunicipality;
                municipalResults.participation = (totalVotesInMunicipality / m.census) * 100;
                results.push(municipalResults);
                totalVotesNational += totalVotesInMunicipality;
            });

            return { municipalResults: results, nationalTotals: totalPartyVotesNational, nationalTotalVotes: totalVotesNational };
        }

        /** Genera y muestra la encuesta nacional simulada (Paso 3). */
        function generateSurvey() {
            if (!validateInput()) return;

            // Obtener Censo Proyectado y actualizar UI
            currentCensusData = getCensusForYear(currentYear);
            
            // 1. Generar Ponderaciones de la Encuesta (Simula una distribuci√≥n normal)
            const surveyWeights = generateRandomWeights(currentCensusData);
            
            // 2. Calcular Votos Nacionales IDEALES (sin ruido municipal, para la base de la encuesta)
            const { nationalTotals, nationalTotalVotes } = calculateVotes(currentCensusData, surveyWeights);

            const surveyDiv = document.getElementById('surveyResults');
            surveyDiv.innerHTML = '';
            document.getElementById('surveySection').classList.remove('hidden');
            
            let surveyNationalPercentages = {};

            PARTIES.forEach(p => {
                const realPercentage = (nationalTotals[p.id] / nationalTotalVotes) * 100;

                // Aplicar error aleatorio DENTRO del MOE
                const randomError = getRandomFloat(-SURVEY_MOE, SURVEY_MOE) * 100;
                const surveyPercentage = Math.max(0, Math.min(100, realPercentage + randomError));

                surveyNationalPercentages[p.id] = surveyPercentage;

                const card = document.createElement('div');
                card.className = 'party-box text-center ' + p.colorClass;
                card.innerHTML = `
                    <p class="text-sm font-semibold text-gray-800">${p.name} (${p.id})</p>
                    <p class="text-3xl font-extrabold mt-1 text-gray-900">${surveyPercentage.toFixed(2)}%</p>
                    <p class="text-xs text-gray-700">Expectativa</p>
                `;
                surveyDiv.appendChild(card);
            });
            
            // 3. Habilitar Ejecuci√≥n de Elecci√≥n
            document.getElementById('btnExecuteElection').disabled = false;
            document.getElementById('resultsSection').classList.add('hidden'); // Ocultar resultados viejos
            showModal("Encuesta Lista", `Se ha generado la expectativa nacional para ${currentYear}-${currentType}. ¬°Ahora ejecuta la elecci√≥n para ver la sorpresa!`);
        }
        
        /** Ejecuta la elecci√≥n real con factores aleatorios (Paso 4). */
        function executeElection() {
            if (!validateInput()) return;
            document.getElementById('btnExecuteElection').disabled = true;

            const electionKey = `${currentYear}-${currentType}`;
            const electionName = formatElectionName(electionKey);

            // 1. Generar una estructura de poder NUEVA y ALEATORIA para el resultado real
            const finalWeights = generateRandomWeights(currentCensusData);

            // 2. Calcular Votos reales con la estructura de poder aleatoria
            const { municipalResults } = calculateVotes(currentCensusData, finalWeights);
            
            // 3. Guardar en Historial
            saveElectionResults(electionKey, electionName, currentCensusData, municipalResults);
                     
            // 4. Renderizar Resultados Finales
            renderFinalResults(municipalResults, electionKey);
            document.getElementById('historySelector').value = electionKey; // Seleccionar la nueva elecci√≥n

            showModal("¬°ELECCI√ìN EJECUTADA!", `Los votos reales para ${electionName} han sido calculados y guardados. ¬°Comprueba si la encuesta acert√≥!`);
        }


        // --- Renderizado de Resultados Finales ---

        function renderFinalResults(results, key) {
            const tbody = document.getElementById('finalResultsTableBody');
            tbody.innerHTML = '';
            document.getElementById('resultsYearAndType').textContent = key;
            document.getElementById('resultsSection').classList.remove('hidden');

            let grandTotalVotes = 0;
            let grandTotalCensus = 0;
            let grandTotalPartyVotes = { USM: 0, UNSM: 0, MNSM: 0 };

            results.forEach((m) => {
                grandTotalVotes += m.totalVotes;
                grandTotalCensus += m.census;
                PARTIES.forEach(p => { grandTotalPartyVotes[p.id] += m.votes[p.id]; });

                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-100 transition duration-150';

                // Columna 1: Municipio
                let cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 bg-white';
                cell.innerHTML = `${m.municipality} <span class="text-xs font-normal text-gray-500">(${m.state})</span>`;

                // Columna 2: Censo
                cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-500 text-center';
                cell.textContent = formatNumber(m.census);

                // Columnas 3, 4, 5: Votos por Partido
                PARTIES.forEach(p => {
                    cell = row.insertCell();
                    cell.className = 'px-3 py-3 whitespace-nowrap text-sm font-bold text-gray-800 text-center';
                    cell.textContent = formatNumber(m.votes[p.id]);
                });

                // Columna 6: Total Votos
                cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm font-bold text-indigo-700 text-center';
                cell.textContent = formatNumber(m.totalVotes);

                // Columna 7: % Participaci√≥n
                cell = row.insertCell();
                cell.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-700 text-center';
                cell.textContent = `${m.participation.toFixed(2)}%`;
            });
            
            // Fila de Totales Nacionales (Solo para referencia, el usuario debe sumarlos)
            const totalRow = tbody.insertRow();
            totalRow.className = 'bg-gray-200 font-extrabold';
            
            totalRow.insertCell().textContent = 'TOTAL NACIONAL';
            totalRow.insertCell().textContent = formatNumber(grandTotalCensus);
            PARTIES.forEach(p => {
                totalRow.insertCell().textContent = formatNumber(grandTotalPartyVotes[p.id]);
            });
            totalRow.insertCell().textContent = formatNumber(grandTotalVotes);
            totalRow.insertCell().textContent = grandTotalCensus > 0 ? `${(grandTotalVotes / grandTotalCensus * 100).toFixed(2)}%` : '0%';
        }

        // --- Funciones de Control y Carga ---
        
        /**
         * Valida la entrada del a√±o, asegurando que no se retroceda en la historia.
         */
        function validateInput() {
            const yearInput = document.getElementById('electionYear');
            currentYear = parseInt(yearInput.value);
            currentType = document.getElementById('electionType').value;
            
            const minAllowedYear = getMinAllowedYear();

            if (isNaN(currentYear) || currentYear < MIN_SAFE_START_YEAR) {
                displayError(`El a√±o electoral debe ser un n√∫mero v√°lido, igual o posterior a ${MIN_SAFE_START_YEAR}.`);
                return false;
            }
            
            // RESTRICCI√ìN PRINCIPAL: No se puede ir antes de la elecci√≥n m√°s antigua registrada.
            if (minAllowedYear !== MIN_SAFE_START_YEAR && currentYear < minAllowedYear) {
                displayError(`No puedes simular una elecci√≥n anterior a la m√°s antigua registrada (${minAllowedYear}).`);
                // Corrige el input al a√±o m√≠nimo permitido para resolver el error
                yearInput.value = minAllowedYear; 
                currentYear = minAllowedYear;
                return false;
            }
            
            return true;
        }

        function updateUIOnFlowChange() {
            if (!validateInput()) return;

            document.getElementById('btnExecuteElection').disabled = true;
            document.getElementById('surveySection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            currentCensusData = getCensusForYear(currentYear);
            const totalCensus = currentCensusData.reduce((acc, m) => acc + m.census, 0);
            
            const censusLabel = currentYear === INITIAL_CENSUS_YEAR ? 'Censo base original' : (currentYear < INITIAL_CENSUS_YEAR ? 'Censo retro-proyectado' : 'Censo proyectado');
            document.getElementById('censusProjection').textContent = `${censusLabel} para ${currentYear}: ${formatNumber(totalCensus)}`;

            document.getElementById('historySelector').value = '';
            document.getElementById('btnManageHistory').disabled = true;
        }

        function loadHistoricalElection() {
            const key = document.getElementById('historySelector').value;
            if (!key) {
                updateUIOnFlowChange(); // Limpiar y resetear al a√±o/tipo actual
                return;
            }

            const history = getHistory();
            const electionData = history[key];
            const [year, type] = key.split('-');

            if (electionData) {
                document.getElementById('electionYear').value = year;
                document.getElementById('electionType').value = type;
                currentYear = parseInt(year);
                currentType = type;
                currentCensusData = electionData.census;

                const totalCensus = currentCensusData.reduce((acc, m) => acc + m.census, 0);
                document.getElementById('censusProjection').textContent = `Censo usado para ${key}: ${formatNumber(totalCensus)}`;

                // Recalcular Totales para generar la encuesta
                let nationalTotals = { USM: 0, UNSM: 0, MNSM: 0 };
                let nationalTotalVotes = 0;
                electionData.results.forEach(m => {
                    PARTIES.forEach(p => { nationalTotals[p.id] += m.votes[p.id]; });
                    nationalTotalVotes += m.totalVotes;
                });
                
                // Mostrar resultados y una encuesta "basada" en ellos (para mantener la estructura de la interfaz)
                generateAndRenderSurvey(nationalTotals, nationalTotalVotes); 
                renderFinalResults(electionData.results, key);
                
                document.getElementById('btnExecuteElection').disabled = true;
                document.getElementById('btnManageHistory').disabled = false;
                
                showModal("Hist√≥rico Cargado", `Se ha cargado: "${electionData.name || formatElectionName(key)}"`);
            } else {
                displayError("No se encontraron datos para la elecci√≥n seleccionada.");
            }
        }
  
        // Funci√≥n auxiliar para renderizar la encuesta al cargar historial
        function generateAndRenderSurvey(nationalTotals, nationalTotalVotes) {
             const surveyDiv = document.getElementById('surveyResults');
            surveyDiv.innerHTML = '';
            document.getElementById('surveySection').classList.remove('hidden');

            const total = nationalTotalVotes;

            PARTIES.forEach(p => {
                const realPercentage = (nationalTotals[p.id] / total) * 100;

                // Aplicar error aleatorio DENTRO del MOE para simular una encuesta
                const randomError = getRandomFloat(-SURVEY_MOE, SURVEY_MOE) * 100;
                const surveyPercentage = Math.max(0, Math.min(100, realPercentage + randomError)); 

                const card = document.createElement('div');
                card.className = 'party-box text-center ' + p.colorClass;

                card.innerHTML = `
                    <p class="text-sm font-semibold text-gray-800">${p.name} (${p.id})</p>
                    <p class="text-3xl font-extrabold mt-1 text-gray-900">${surveyPercentage.toFixed(2)}%</p>
                    <p class="text-xs text-gray-700">Expectativa</p>
                `;
                surveyDiv.appendChild(card);
            });
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
